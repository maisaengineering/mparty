<div class="row" id="payment_method" data-hook="checkout_payment_step">
  <div class="col-md-6 event_left_block">
    <div class="col-md-12" data-hook="checkout_payment_step">

      <% if @payment_sources.present? %>
          <div class="card_options">
            <%= radio_button_tag 'use_existing_card', 'yes', true %>
            <label for="use_existing_card_yes">Use an existing card on file</label>
            <br/>
            <%= radio_button_tag 'use_existing_card', 'no' %>
            <label for="use_existing_card_no">Use a new card / payment method</label>
          </div>

          <div id="existing_cards">
            <p class="field" data-hook="existing_cards">
            <table class="existing-credit-card-list">
              <tbody>
              <% @payment_sources.each do |card| %>
                  <tr id="<%= dom_id(card,'spree')%>" class="<%= cycle('even', 'odd') %>">
                    <td><%= card.name %></td>
                    <td><%= card.display_number %></td>
                    <td><%= card.month %></td>
                    <td><%= card.year %></td>
                    <td>
                      <%= radio_button_tag "existing_card", card.id, (card == @payment_sources.first), { class: "existing-cc-radio" }  %>
                    </td>
                  </tr>
              <% end %>
              </tbody>
            </table>
            </p>
          </div>
      <% end %>

      <div id="payment-method-fields" data-hook>
        <% @order.available_payment_methods.each do |method| %>
            <p>
              <label>
                <%= radio_button_tag "order[payments_attributes][][payment_method_id]", method.id, method == @order.available_payment_methods.first %>
                <%= Spree.t(method.name, :scope => :payment_methods, :default => method.name) %>
              </label>
            </p>
        <% end %>
      </div>

      <ul id="payment-methods" data-hook>
        <% @order.available_payment_methods.each do |method| %>
            <div id="payment_method_<%= method.id %>" class="row <%= 'last' if method == @order.available_payment_methods.last %>" data-hook>
              <%= render :partial => "spree/checkout/payment/#{method.method_type}", :locals => { :payment_method => method } %>
            </div>
        <% end %>
      </ul>
      <div class="row">
        <div class="col-md-6" data-hook="coupon_code">
          <%= form.text_field :coupon_code ,class: 'form-control',placeholder: 'Coupon Code if any'%>
        </div>
      </div>
      <div class="col-md-12">
        <label></label>
        <%= submit_tag Spree.t(:save_and_continue), :class => 'btn btn-lg btn-primary btn-block pay_now_btn' ,disable_with: 'Please wait...'%>
      </div>
    </div>
  </div>
  <div class="col-md-6 event_right_block">
    <% if @order.bill_address %>
        <% bill_address = @order.bill_address  %>
        <h4>Billing Address <a href="/checkout/address" class="">(Edit)</a></h4>
        <div class="row">
          <div class="col-md-3">NAME:</div><div class="col-md-9"><%= bill_address.full_name %></div>
          <div class="col-md-3">ADDRESS:</div><div class="col-md-9"><%="#{bill_address.address1} #{bill_address.address2}" %></div>
          <div class="col-md-3">CITY:</div><div class="col-md-9"><%=bill_address.city %></div>
          <div class="col-md-3">STATE</div><div class="col-md-9"><%= bill_address.state_text %></div>
          <div class="col-md-3">COUNTRY:</div><div class="col-md-9"><%= bill_address.country.name %></div>
          <div class="col-md-3">ZIPCODE:</div><div class="col-md-9"><%= bill_address.zipcode %></div>
        </div>
    <% end %>

    <% @event = Event.find(session[:event_id]) if session[:event_id].present? %>
    <% if @event and @event.ship_address %>
        <% ship_address = @order.ship_address  %>
        <h4>Shipping Address</h4>
        <div class="row">
          <div class="col-md-3">NAME:</div><div class="col-md-9"><%= ship_address.full_name %></div>
          <div class="col-md-3">ADDRESS:</div><div class="col-md-9"><%="#{ship_address.address1} #{ship_address.address2}" %></div>
          <div class="col-md-3">CITY:</div><div class="col-md-9"><%=ship_address.city %></div>
          <div class="col-md-3">STATE</div><div class="col-md-9"><%= ship_address.state_text %></div>
          <div class="col-md-3">COUNTRY:</div><div class="col-md-9"><%= ship_address.country.name %></div>
          <div class="col-md-3">ZIPCODE:</div><div class="col-md-9"><%= ship_address.zipcode %></div>
        </div>
    <% end %>


  </div>
</div>


<script type="text/javascript">
    function onPayment() {
        if (($('#checkout_form_payment')).is('*')) {
            if (($('#existing_cards')).is('*')) {
                ($('#payment-method-fields')).hide();
                ($('#payment-methods')).hide();
                ($('#use_existing_card_yes')).click(function() {
                    ($('#payment-method-fields')).hide();
                    ($('#payment-methods')).hide();
                    return ($('.existing-cc-radio')).prop("disabled", false);
                });
                ($('#use_existing_card_no')).click(function() {
                    ($('#payment-method-fields')).show();
                    ($('#payment-methods')).show();
                    return ($('.existing-cc-radio')).prop("disabled", true);
                });
            }
            $(".cardNumber").payment('formatCardNumber');
            $(".cardExpiry").payment('formatCardExpiry');
            $(".cardCode").payment('formatCardCVC');
            $(".cardNumber").change(function() {
                return $(this).parent().siblings(".ccType").val($.payment.cardType(this.value));
            });
            ($('input[type="radio"][name="order[payments_attributes][][payment_method_id]"]')).click(function() {
                ($('#payment-methods li')).hide();
                if (this.checked) {
                    return ($('#payment_method_' + this.value)).show();
                }
            });
            ($(document)).on('click', '#cvv_link', function(event) {
                var windowName, windowOptions;
                windowName = 'cvv_info';
                windowOptions = 'left=20,top=20,width=500,height=500,toolbar=0,resizable=0,scrollbars=1';
                window.open(($(this)).attr('href'), windowName, windowOptions);
                return event.preventDefault();
            });
            ($('input[type="radio"]:checked')).click();
            return $('#checkout_form_payment').submit(function() {
                var coupon_code, coupon_code_field, coupon_status, url;
                coupon_code_field = $('#order_coupon_code');
                coupon_code = $.trim(coupon_code_field.val());
                if (coupon_code !== '') {
                    if ($('#coupon_status').length === 0) {
                        coupon_status = $("<div id='coupon_status'></div>");
                        coupon_code_field.parent().append(coupon_status);
                    } else {
                        coupon_status = $("#coupon_status");
                    }
                    url = Spree.url(Spree.routes.apply_coupon_code(Spree.current_order_id), {
                        order_token: Spree.current_order_token,
                        coupon_code: coupon_code
                    });
                    coupon_status.removeClass();
                    return $.ajax({
                        async: false,
                        method: "PUT",
                        url: url,
                        success: function(data) {
                            coupon_code_field.val('');
                            coupon_status.addClass("success").html("Coupon code applied successfully.");
                            return true;
                        },
                        error: function(xhr) {
                            var handler;
                            handler = JSON.parse(xhr.responseText);
                            coupon_status.addClass("error").html(handler["error"]);
                            $('.continue').attr('disabled', false);
                            return false;
                        }
                    });
                }
            });
        }
    };
    onPayment();

</script>